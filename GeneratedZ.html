<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Эксперимент доверия к лицам</title>

  <!-- jsPsych -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css"
        rel="stylesheet" type="text/css" />

  <!-- Плагины -->
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-instructions@1.1.3"></script>

  <!-- DataPipe (для отправки данных на OSF) -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.5.0"></script>

  <style>
    body {
      background-color: #ffffff;
    }
    #jspsych-target {
      max-width: 900px;
      margin: 40px auto;
    }
  </style>
</head>
<body>
  <div id="jspsych-target">
    Если вы видите только этот текст, значит JavaScript ещё не запустился
    или произошла ошибка. Подождите пару секунд.
  </div>

  <script>
    (function () {
      const container = document.getElementById('jspsych-target');

      // 1) jsPsych не загрузился с CDN
      if (typeof initJsPsych === 'undefined') {
        container.innerHTML =
          '<p><b>Не удалось загрузить библиотеку jsPsych.</b></p>' +
          '<p>Попробуйте открыть страницу в другом браузере или через VPN. ' +
          'Если вы экспериментатор, проверьте доступ к <code>https://unpkg.com</code>.</p>';
        return;
      }

      // 2) плагины не загрузились
      if (typeof jsPsychHtmlSliderResponse === 'undefined' ||
          typeof jsPsychInstructions === 'undefined') {
        container.innerHTML =
          '<p><b>Не удалось загрузить плагины jsPsych.</b></p>' +
          '<p>Проверьте теги &lt;script&gt; для плагинов ' +
          '<code>plugin-html-slider-response</code> и ' +
          '<code>plugin-instructions</code>.</p>';
        return;
      }

      // ---------- jsPsych-эксперимент ----------

      const jsPsych = initJsPsych({
        display_element: container,
        on_finish: function () {
          // Для отладки можно включить отображение данных:
          // jsPsych.data.displayData('csv');
        }
      });

      const timeline = [];

      // Список стимулов (поменяй имена файлов на свои при необходимости)
      const stimuli = [
        { image: 'img/portrait01.png', condition: 'no_label' },
        { image: 'img/portrait02.png', condition: 'ai_label' },
        { image: 'img/portrait03.png', condition: 'no_label' },
        { image: 'img/portrait04.png', condition: 'ai_label' },
        // добавь сюда остальные портреты по той же схеме
      ];

      // Перемешивание с минимальным расстоянием между одинаковыми изображениями
      function validShuffle(items, minGap = 3, maxAttempts = 20000) {
        const n = items.length;
        if (n === 0) return [];
        let attempts = 0;

        while (attempts < maxAttempts) {
          attempts++;
          const seq = items.slice();

          // Фишер–Йейтс
          for (let i = seq.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [seq[i], seq[j]] = [seq[j], seq[i]];
          }

          let ok = true;
          for (let i = 0; i <= n - (minGap + 1); i++) {
            const window = seq.slice(i, i + minGap + 1).map(rec => rec.image);
            const unique = new Set(window);
            if (unique.size !== window.length) {
              ok = false;
              break;
            }
          }
          if (ok) return seq;
        }

        throw new Error('Не удалось сгенерировать последовательность после ' +
                        maxAttempts + ' попыток');
      }

      const sequence = validShuffle(stimuli, 3);

      // Инструкции
      const instructions = {
        type: jsPsychInstructions,
        pages: [
          '<p><b>Спасибо за участие в исследовании.</b></p>' +
          '<p>Вам будут показаны портреты людей. ' +
          'Ваша задача — оценить, насколько вы доверяете этому человеку.</p>' +
          '<p>Используйте ползунок от 1 (совсем не доверяю) до 10 (полностью доверяю).</p>' +
          '<p>Нажмите «Далее», чтобы начать.</p>'
        ],
        show_clickable_nav: true,
        allow_backward: false,
        button_label_next: 'Далее'
      };
      timeline.push(instructions);

      // Один пробный стимул (типичный слайдер)
      const rating_trial = {
        type: jsPsychHtmlSliderResponse,
        stimulus: function () {
          const img = jsPsych.timelineVariable('image');
          return `
            <div style="text-align:center;">
              <img src="${img}" style="max-height:480px;"><br>
            </div>
            <p style="text-align:center; font-size:18px;">
              Насколько вы доверяете этому человеку?
            </p>`;
        },
        min: 1,
        max: 10,
        slider_start: 5,
        step: 1,
        labels: ['1','2','3','4','5','6','7','8','9','10'],
        require_movement: true,
        button_label: 'Далее',
        data: {
          image: jsPsych.timelineVariable('image'),
          condition: jsPsych.timelineVariable('condition')
        }
      };

      const rating_block = {
        timeline: [rating_trial],
        timeline_variables: sequence
      };
      timeline.push(rating_block);

      // Завершение
      const ending = {
        type: jsPsychInstructions,
        pages: [
          '<p>Эксперимент завершён. Спасибо за участие!</p>' +
          '<p>Вы можете закрыть вкладку.</p>'
        ],
        show_clickable_nav: true,
        allow_backward: false,
        button_label_next: 'Готово'
      };
      timeline.push(ending);

      // Отправка на OSF через DataPipe (опционально)
      const DATAPIPE_EXPERIMENT_ID = 'ВСТАВЬ_СЮДА_ID_ИЗ_DATAPIPE';

      if (typeof jsPsychPipe !== 'undefined' &&
          DATAPIPE_EXPERIMENT_ID !== 'ВСТАВЬ_СЮДА_ID_ИЗ_DATAPIPE') {

        const subject_id = jsPsych.randomization.randomID(10);
        const filename = `generatedZ_${subject_id}.csv`;

        const save_data = {
          type: jsPsychPipe,
          action: 'save',
          experiment_id: DATAPIPE_EXPERIMENT_ID,
          filename: filename,
          data_string: () => jsPsych.data.get().csv()
        };

        timeline.push(save_data);
      }

      jsPsych.run(timeline);
    })();
  </script>
</body>
</html>
