<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Vpechatlilis?</title>

  <!-- jsPsych core + стили (через CDN) -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />

  <!-- Плагины jsPsych (через CDN) -->
  <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
  <script src="jspsych-survey-html-form.js"></script>

  <!-- Плагин для отправки данных в DataPipe/OSF -->
  <script src="https://unpkg.com/@jspsych-contrib/plugin-pipe@0.5.0"></script>


  
  <style>
    body {
      background-color: #f7f7f7;
    }
    #jspsych-target {
      max-width: 900px;
      margin: 40px auto;
    }
    .instr {
      max-width: 800px;
      margin: 40px auto;
      text-align: left;
      line-height: 1.5;
      font-size: 18px;
    }
    .face-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .face-container img {
      max-width: 350px;
      height: auto;
      margin-bottom: 20px;
      border-radius: 8px;
    }
    .question-text {
      margin-bottom: 20px;
      font-size: 20px;
      text-align: center;
    }
  </style>
</head>
<body>
  <div id="jspsych-target">
    <p>
      Если вы видите только этот текст и ничего больше не происходит,
      значит скрипты эксперимента не загрузились.
      Попробуйте обновить страницу или открыть её в другом браузере.
    </p>
  </div>

  <script>
  (function() {
    const container = document.getElementById('jspsych-target');

    // Если jsPsych не подтянулся с CDN
    if (typeof initJsPsych === 'undefined') {
      container.innerHTML =
        '<p><b>Не удалось загрузить библиотеку jsPsych.</b></p>' +
        '<p>Попробуйте отключить блокировщики рекламы/VPN ' +
        'или открыть страницу в другом браузере.</p>';
      return;
    }

    const jsPsych = initJsPsych({
      display_element: container,
      on_finish: function() {
        // Резервное локальное сохранение при необходимости:
        // jsPsych.data.get().localSave('csv', 'genesis_data_backup.csv');
      }
    });

    const timeline = [];

    // --- ВЕРСИЯ ЭКСПЕРИМЕНТА ---
    // На втором сайте поменяешь на "scheme_B" или другое имя
    const EXPERIMENT_VERSION = "scheme_A";
    let subject_id = null;

    // --- Ввод кода участника через prompt (нельзя пропустить) ---
(function getParticipantID() {
  let pid = null;

  while (!pid) {
    const raw = window.prompt(
      "Пожалуйста, введите ваше Имя и Фамилию:",
      ""
    );

    // Нажали "Отмена" или закрыли окно → спрашиваем снова
    if (raw === null) {
      continue;
    }

    // Убираем пробелы по краям
    const trimmed = raw.trim();

    // Если пусто или только пробелы → показываем предупреждение и спрашиваем снова
    if (trimmed.length === 0) {
      alert("Пожалуйста, введите ваше Имя и Фамилию.");
      continue;
    }

    // Если нужно, можно дополнительно отфильтровать только буквы/цифры:
    // if (!/^[A-Za-zА-Яа-я0-9_-]+$/.test(trimmed)) {
    //   alert("Разрешены только буквы, цифры, дефис и подчёркивание.");
    //   continue;
    // }

    pid = trimmed; // валидный ID
  }

  subject_id = pid;

  jsPsych.data.addProperties({
    participant_id: subject_id,
    version: EXPERIMENT_VERSION
  });
})();


    // -------- 1. Словарь текстов вопросов --------
    const questions_dict = {
      attraction: "Насколько этот человек привлекателен?",
      intellect: "Насколько этот человек интеллектуален?",
      trust: "Насколько Вы доверяете этому человеку?"
    };

    // -------- 2. Структура стимулов --------
    const stimuli = [
      { image: "img/portrait01.png", question: "trust", iv_source: "real" },
      { image: "img/portrait01.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait01.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait02.png", question: "trust", iv_source: "real" },
      { image: "img/portrait02.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait02.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait03.png", question: "trust", iv_source: "real" },
      { image: "img/portrait03.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait03.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait04.png", question: "trust", iv_source: "real" },
      { image: "img/portrait04.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait04.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait05.png", question: "trust", iv_source: "real" },
      { image: "img/portrait05.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait05.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait06.png", question: "trust", iv_source: "real" },
      { image: "img/portrait06.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait06.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait07.png", question: "trust", iv_source: "real" },
      { image: "img/portrait07.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait07.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait08.png", question: "trust", iv_source: "real" },
      { image: "img/portrait08.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait08.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait09.png", question: "trust", iv_source: "real" },
      { image: "img/portrait09.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait09.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait10.png", question: "trust", iv_source: "real" },
      { image: "img/portrait10.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait10.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait11.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait11.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait11.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait12.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait12.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait12.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait13.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait13.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait13.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait14.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait14.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait14.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait15.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait15.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait15.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait16.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait16.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait16.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait17.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait17.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait17.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait18.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait18.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait18.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait19.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait19.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait19.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait20.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait20.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait20.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait21.png", question: "trust", iv_source: "real" },
      { image: "img/portrait21.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait21.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait22.png", question: "trust", iv_source: "real" },
      { image: "img/portrait22.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait22.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait23.png", question: "trust", iv_source: "real" },
      { image: "img/portrait23.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait23.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait24.png", question: "trust", iv_source: "real" },
      { image: "img/portrait24.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait24.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait25.png", question: "trust", iv_source: "real" },
      { image: "img/portrait25.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait25.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait26.png", question: "trust", iv_source: "real" },
      { image: "img/portrait26.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait26.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait27.png", question: "trust", iv_source: "real" },
      { image: "img/portrait27.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait27.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait28.png", question: "trust", iv_source: "real" },
      { image: "img/portrait28.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait28.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait29.png", question: "trust", iv_source: "real" },
      { image: "img/portrait29.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait29.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait30.png", question: "trust", iv_source: "real" },
      { image: "img/portrait30.png", question: "attraction", iv_source: "real" },
      { image: "img/portrait30.png", question: "intellect", iv_source: "real" },
      { image: "img/portrait31.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait31.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait31.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait32.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait32.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait32.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait33.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait33.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait33.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait34.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait34.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait34.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait35.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait35.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait35.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait36.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait36.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait36.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait37.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait37.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait37.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait38.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait38.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait38.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait39.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait39.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait39.png", question: "intellect", iv_source: "ai" },
      { image: "img/portrait40.png", question: "trust", iv_source: "ai" },
      { image: "img/portrait40.png", question: "attraction", iv_source: "ai" },
      { image: "img/portrait40.png", question: "intellect", iv_source: "ai" }
    ];


    // -------- 3. validShuffle (минимум 3 trial'а между одинаковыми фото) --------
    function validShuffle(items, minGap = 3, maxAttempts = 20000) {
      const n = items.length;
      if (n === 0) {
        return [];
      }

      let attempts = 0;

      while (attempts < maxAttempts) {
        attempts++;

        const seq = jsPsych.randomization.shuffle([...items]);

        let ok = true;

        for (let i = 0; i <= n - (minGap + 1); i++) {
          const window = seq
            .slice(i, i + minGap + 1)
            .map(rec => rec.image);

          const unique = new Set(window);
          if (unique.size !== window.length) {
            ok = false;
            break;
          }
        }

        if (ok) {
          return seq;
        }
      }

      throw new Error("Не удалось сгенерировать последовательность после " + maxAttempts + " попыток");
    }

    const min_gap_photos = 3;
    const sequence = validShuffle(stimuli, min_gap_photos);
    const images_to_preload = sequence.map(s => s.image);

    // -------- 4. Предзагрузка --------
    const preload = {
      type: jsPsychPreload,
      images: images_to_preload,
      data: { phase: "preload" }
    };
    timeline.push(preload);

    // -------- 5. Инструкции --------
    const instructions_html = `
      <div class="instr">
        <p>Спасибо, что согласились принять участие в этом эксперименте.</p>

        <p>Внешность служит важным источником информации при формировании мнения о человеке. 
        Мы исследуем влияние конкретных черт лица на впечатление о личностных характеристиках.</p>

        <p>Вам предстоит оценить характеристики моделей по фото их лиц. 
        В контрольных целях помимо фото реальных лиц 
        в эксперименте задействованы ИИ-модели, 
        их фото сопровождаются меткой "AI-generated".</p>

        <p>Для оценки модели выберите оценку на шкале от 1 до 10, 
        исходя из своего первого впечатления.</p>

        <p style="margin-top: 30px; text-align: center;">
          Нажмите пробел, чтобы начать.
        </p>
      </div>
    `;

    const instr = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: instructions_html,
      choices: [" "],
      data: { phase: "instructions" }
    };
    timeline.push(instr);

    // -------- 6. Основной блок trial'ов --------
    const trial_procedure = {
      timeline: [
        {
          type: jsPsychHtmlSliderResponse,
          stimulus: function() {
            const img_path = jsPsych.timelineVariable('image');
            const question_code = jsPsych.timelineVariable('question');
            const question_text = questions_dict[question_code] || question_code;

            return `
              <div class="face-container">
                <img src="${img_path}" alt="face">
                <div class="question-text">${question_text}</div>
              </div>
            `;
          },
          min: 1,
          max: 10,
          step: 1,
          slider_start: 5,
          labels: ["1","2","3","4","5","6","7","8","9","10"],
          require_movement: true,
          prompt: "<p style='text-align:center; margin-top:20px;'>Выберите ответ на шкале и нажмите кнопку ниже.</p>",
          button_label: "Далее",
          data: {
            phase: "trial",
            image: jsPsych.timelineVariable('image'),
            question_code: jsPsych.timelineVariable('question'),
            iv_source: jsPsych.timelineVariable('iv_source')
          },
          on_finish: function(data) {
            data.rating_slider = data.response;
            data.rating_rt = data.rt;
          }
        }
      ],
      timeline_variables: sequence,
      randomize_order: false
    };

    timeline.push(trial_procedure);

    // -------- 7. Контрольные вопросы --------
    const contr1 = {
      type: jsPsychSurveyLikert,
      preamble: "<p>Обращали ли вы внимание на возможные метки «AI-generated» на фотографиях?</p>",
      questions: [
        {
          prompt: "",
          labels: ["да", "нет"],
          required: true
        }
      ],
      data: { phase: "control_1" }
    };
    timeline.push(contr1);

    const contr2 = {
      type: jsPsychSurveyLikert,
      preamble: "<p>Насколько вы, по вашему ощущению, склонны к техно-скепсису (недоверию к ИИ и другим технологиям)?</p>",
      questions: [
        {
          prompt: "",
          labels: ["1", "2", "3", "4", "5"],
          required: true
        }
      ],
      data: { phase: "control_2" }
    };
    timeline.push(contr2);
    const age_question = {
  type: jsPsychSurveyHtmlForm,
  preamble: '<p>Пожалуйста, укажите ваш возраст.</p>',
  html: `
    <p>
      <label>Возраст:
        <input
          name="age"
          type="text"
          inputmode="numeric"
          pattern="[0-9]{1,2}"
          maxlength="2"
          required
          style="width: 3em; text-align: center;"
        />
        лет
      </label>
    </p>
  `,
  autofocus: 'age',
  button_label: 'Далее',
  data: { task: 'age' }
};
timeline.push(age_question);
    const contr3 = {
      type: jsPsychSurveyText,
      preamble: `
        <p>Если у вас появлялись догадки о целях эксперимента, опишите их, пожалуйста.</p>
        <p>Если догадок не было, можете оставить поле пустым и нажать кнопку.</p>
      `,
      questions: [
        { prompt: "", rows: 6, columns: 60, name: "hypothesis_guess" }
      ],
      button_label: "Закончить",
      data: { phase: "control_3" }
    };
    timeline.push(contr3);

    // -------- 8. Сохранение данных через DataPipe --------
    const sid_for_file = subject_id || jsPsych.randomization.randomID(10);
    const filename = `genesis_${EXPERIMENT_VERSION}_${sid_for_file}.csv`;

    if (typeof jsPsychPipe !== "undefined") {
      const save_data = {
        type: jsPsychPipe,
        action: "save",
        experiment_id: "xbmFHJ1FoCIj",
        filename: filename,
        data_string: () => jsPsych.data.get().csv()
      };
      timeline.push(save_data);
    }

    // -------- 9. Финальный экран --------
    const end_screen = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: `
        <div class="instr" style="text-align:center;">
          <p>Спасибо за участие!</p>
          <p>Ваши ответы сохранены на защищённом сервере исследования.</p>
          <p style="margin-top:30px;">Нажмите пробел, чтобы завершить.</p>
        </div>
      `,
      choices: [" "],
      data: { phase: "end" }
    };
    timeline.push(end_screen);

    // -------- 10. Запуск эксперимента --------
    jsPsych.run(timeline);

  })();
  </script>
</body>
</html>
